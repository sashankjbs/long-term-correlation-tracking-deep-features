function [H] = computeConvFeatures(img, cell_size, cos_window, net, mean_data)


input_data = {prepare_image(img)};

net.forward(input_data);

%H = net.blobs('conv3_3').get_data();
H = net.blobs('res2c').get_data();

H = permute(H, [2, 1, 3]);

if(~isempty(cos_window))
    H = bsxfun(@times, H, cos_window);
end

end

% ------------------------------------------------------------------------
function crops_data = prepare_image(im)
% ------------------------------------------------------------------------
% caffe/matlab/+caffe/imagenet/ilsvrc_2012_mean.mat contains mean_data that
% is already in W x H x C with BGR channels

% Convert an image returned by Matlab's imread to im_data in caffe's data
% format: W x H x C with BGR channels
im_data = im(:, :, [3, 2, 1]);  % permute channels from RGB to BGR
im_data = single(im_data);  % convert from uint8 to single

% mean(:,:,1) = repmat([104.00698793], size(im_data, 1), size(im_data, 2));
% mean(:,:,2) = repmat([116.66876762], size(im_data, 1), size(im_data, 2));
% mean(:,:,3) = repmat([122.67891434], size(im_data, 1), size(im_data, 2));

im_data = permute(im_data, [2, 1, 3]);  % flip width and height

%im_data = imresize(im_data, 4, 'bilinear');  % resize im_data
% oversample (4 corners, center, and their x-axis flips)
crops_data = im_data;
end